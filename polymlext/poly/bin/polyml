#!/usr/bin/env bash
HERE=$(dirname "$0")
PRG=$(basename "$0")
POLYML_HOME=$("$HERE/findpoly.sh")
THE_POLY_HEAP="polymlext.polyml-heap"
THE_POLY_PROGRAM="main.sml"

if [ "$POLYML_HOME" == "" ]
then
    echo "Can not find PolyML"; exit 3; 
else
    echo "Using PolyML: $POLYML_HOME";
fi

PORT1=$1
PORT2=$2
SANDBOX_PATH=$3
if [ -z "$PORT1" ] || [ -z "$PORT2" ] || [ -z "$SANDBOX_PATH" ]
then 
    echo "Usage: $PRG port1 port2 sandbox_path" >&2
    exit 2; # fail
fi

#compile the isaplib
if [ ! -e "$HERE/../isaplib/heaps/all.polyml-heap" ]
then
    # compilation, based on Makefile of IsapLib
    cd "$HERE/../isaplib/"
    (echo 'use "ROOT.ML"; PolyML.fullGC (); OS.FileSys.getDir(); PolyML.SaveState.saveState "heaps/all.polyml-heap"; ';) \
           | "${POLYML_HOME}/bin/poly" "$@";
    cd ../bin
fi

#development mode ignores the heap file
if [ "$4" == "dev" ]
then
    #compile the main.sml
    (echo "OS.FileSys.chDir(\"$HERE/../\");
           PolyML.use \"${THE_POLY_PROGRAM}\";
           val _ = PolyMLext.main($PORT1,$PORT2,\"$SANDBOX_PATH\");") \
           | ${POLYML_HOME}/bin/poly "$@";
else
    #build the heap if needed
    if [ ! -e "$HERE/$THE_POLY_HEAP" ]
    then
        (echo "OS.FileSys.chDir(\"$HERE/../\");
               PolyML.use \"${THE_POLY_PROGRAM}\";
               PolyML.SaveState.saveState \"bin/${THE_POLY_HEAP}\"";) \
               | ${POLYML_HOME}/bin/poly "$@";
    fi
    #load the heap
    (echo "OS.FileSys.chDir(\"$HERE\");
           PolyML.SaveState.loadState \"${THE_POLY_HEAP}\";
           val _ = PolyMLext.main($PORT1,$PORT2,\"$SANDBOX_PATH\");";) \
           | ${POLYML_HOME}/bin/poly "$@";
fi